# Garfenter Contable - One-Click Deployment
# Based on Bigcapital accounting system
# Configured for Guatemala market with Spanish locale and GTQ currency

version: '3.8'

services:
  # PostgreSQL Database
  garfenter-postgres:
    image: postgres:15-alpine
    container_name: garfenter-contable-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${SYSTEM_DB_NAME:-garfenter_system}
      - POSTGRES_USER=${DB_USER:-garfenter}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-garfenter_secure_2024}
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --lc-collate=es_GT.UTF-8 --lc-ctype=es_GT.UTF-8
      - TZ=America/Guatemala
    volumes:
      - garfenter_postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - garfenter_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-garfenter} -d ${SYSTEM_DB_NAME:-garfenter_system}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB for job queue
  garfenter-mongo:
    image: mongo:7-jammy
    container_name: garfenter-contable-mongo
    restart: unless-stopped
    environment:
      - TZ=America/Guatemala
    volumes:
      - garfenter_mongo_data:/data/db
    expose:
      - "27017"
    networks:
      - garfenter_network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis cache and session store
  garfenter-redis:
    image: redis:7-alpine
    container_name: garfenter-contable-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      - TZ=America/Guatemala
    volumes:
      - garfenter_redis_data:/data
    expose:
      - "6379"
    networks:
      - garfenter_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Gotenberg PDF Generator
  garfenter-gotenberg:
    image: gotenberg/gotenberg:7
    container_name: garfenter-contable-gotenberg
    restart: unless-stopped
    environment:
      - TZ=America/Guatemala
    expose:
      - "3000"
    networks:
      - garfenter_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Database Migration Service
  garfenter-migration:
    container_name: garfenter-contable-migration
    build:
      context: ./
      dockerfile: docker/migration/Dockerfile
    environment:
      # Database
      - DB_HOST=garfenter-postgres
      - DB_USER=${DB_USER:-garfenter}
      - DB_PASSWORD=${DB_PASSWORD:-garfenter_secure_2024}
      - DB_CHARSET=utf8
      - DB_PORT=5432
      # System database
      - SYSTEM_DB_NAME=${SYSTEM_DB_NAME:-garfenter_system}
      # Tenant databases
      - TENANT_DB_NAME_PERFIX=${TENANT_DB_NAME_PERFIX:-garfenter_tenant_}
      - TZ=America/Guatemala
    depends_on:
      garfenter-postgres:
        condition: service_healthy
    networks:
      - garfenter_network
    restart: on-failure

  # Backend API Server
  garfenter-contable:
    container_name: garfenter-contable-api
    build:
      context: ./
      dockerfile: ./packages/server/Dockerfile
    restart: unless-stopped
    expose:
      - "3000"
    ports:
      - "${API_PORT:-3000}:3000"
    depends_on:
      garfenter-postgres:
        condition: service_healthy
      garfenter-mongo:
        condition: service_healthy
      garfenter-redis:
        condition: service_healthy
      garfenter-migration:
        condition: service_completed_successfully
    networks:
      - garfenter_network
    environment:
      # Application
      - NODE_ENV=production
      - BASE_URL=${BASE_URL:-http://localhost}
      - JWT_SECRET=${JWT_SECRET:-garfenter_jwt_secret_change_in_production}
      - TZ=America/Guatemala

      # Localization - Guatemala Configuration
      - DEFAULT_LOCALE=es
      - DEFAULT_CURRENCY=GTQ
      - DEFAULT_TIMEZONE=America/Guatemala

      # Database - PostgreSQL
      - DB_HOST=garfenter-postgres
      - DB_PORT=5432
      - DB_USER=${DB_USER:-garfenter}
      - DB_PASSWORD=${DB_PASSWORD:-garfenter_secure_2024}
      - DB_CHARSET=utf8

      # System database
      - SYSTEM_DB_NAME=${SYSTEM_DB_NAME:-garfenter_system}

      # Tenant databases
      - TENANT_DB_NAME_PERFIX=${TENANT_DB_NAME_PERFIX:-garfenter_tenant_}

      # MongoDB
      - MONGODB_DATABASE_URL=mongodb://garfenter-mongo:27017/garfenter_contable

      # Redis
      - REDIS_HOST=garfenter-redis
      - REDIS_PORT=6379

      # Mail
      - MAIL_HOST=${MAIL_HOST:-}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_SECURE=${MAIL_SECURE:-false}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-Garfenter Contable}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-contable@garfenter.com}

      # Gotenberg PDF Generator
      - GOTENBERG_URL=http://garfenter-gotenberg:3000
      - GOTENBERG_DOCS_URL=http://garfenter-contable:3000/public/

      # Agendash (Job Queue Admin)
      - AGENDASH_AUTH_USER=${AGENDASH_AUTH_USER:-admin}
      - AGENDASH_AUTH_PASSWORD=${AGENDASH_AUTH_PASSWORD:-change_this_password}

      # Sign-up Configuration
      - SIGNUP_DISABLED=${SIGNUP_DISABLED:-false}
      - SIGNUP_ALLOWED_DOMAINS=${SIGNUP_ALLOWED_DOMAINS:-}
      - SIGNUP_ALLOWED_EMAILS=${SIGNUP_ALLOWED_EMAILS:-}
      - SIGNUP_EMAIL_CONFIRMATION=${SIGNUP_EMAIL_CONFIRMATION:-false}

      # Exchange Rate Service
      - EXCHANGE_RATE_SERVICE=${EXCHANGE_RATE_SERVICE:-open-exchange-rate}
      - OPEN_EXCHANGE_RATE_APP_ID=${OPEN_EXCHANGE_RATE_APP_ID:-}

      # Bank Feed (Optional)
      - BANK_FEED_ENABLED=${BANK_FEED_ENABLED:-false}

      # S3 Storage (Optional)
      - S3_REGION=${S3_REGION:-}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID:-}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY:-}
      - S3_ENDPOINT=${S3_ENDPOINT:-}
      - S3_BUCKET=${S3_BUCKET:-}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend Web Application
  garfenter-webapp:
    container_name: garfenter-contable-webapp
    build:
      context: ./
      dockerfile: ./packages/webapp/Dockerfile
    restart: unless-stopped
    ports:
      - "${WEBAPP_PORT:-4000}:80"
    depends_on:
      - garfenter-contable
    networks:
      - garfenter_network
    environment:
      - TZ=America/Guatemala
      - REACT_APP_API_URL=${BASE_URL:-http://localhost:3000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

# Persistent volumes
volumes:
  garfenter_postgres_data:
    name: garfenter_contable_postgres
    driver: local
  garfenter_mongo_data:
    name: garfenter_contable_mongo
    driver: local
  garfenter_redis_data:
    name: garfenter_contable_redis
    driver: local

# Network
networks:
  garfenter_network:
    name: garfenter_contable_network
    driver: bridge
